name: Run CI Tests

on:
  push:
    branches: [ master ]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release
  CC: ${{github.workspace}}/llvm/bin/clang
  CXX: ${{github.workspace}}/llvm/bin/clang++

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        submodules: true

    - name: Get LLVM from cache
      id: cache-llvm
      uses: actions/cache@v3
      with:
        path: |
          C:/Program Files/LLVM
          ./llvm
        key: llvm-cache

    - name: Install LLVM
      uses: KyleMayes/install-llvm-action@v1
      with:
        version: "15"
        cached: ${{ steps.cache-llvm.outputs.cache-hit }}

    - name: Run vcpkg
      uses: lukka/run-vcpkg@v10
      id: runvcpkg
      with:
        vcpkgDirectory: '${{ runner.workspace }}/b/vcpkg'
        vcpkgGitCommitId: '94bfbda514961bf2e29ef803c975ec36379d75e5'
        vcpkgJsonGlob: '**/vcpkg.json'

    - name: Install cmake
      uses: lukka/get-cmake@latest

    - name: Get dependencies and build
      uses: lukka/run-cmake@v10
      with:
        cmakeListsTxtPath: '${{ github.workspace }}/CMakeLists.txt'
        configurePreset: 'x64-library'
        buildPreset: 'x64-cgamelink'

    - name: Archive the .so
      uses: actions/upload-artifact@v3
      with:
        name: libcgamelink.so
        path: builds/x64-library/Release/libcgamelink.so